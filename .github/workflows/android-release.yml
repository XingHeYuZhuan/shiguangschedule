name: Android Production Release (Manual)

# åªèƒ½æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      build_run_id:
        description: 'è¯·å¡«å†™ Build CI æˆåŠŸçš„ Run ID (ä¾‹å¦‚ï¼š123456789)'
        required: true
        type: string
      build_flavor:
        description: 'è¯·é€‰æ‹©è¦å‘å¸ƒçš„ç‰ˆæœ¬é£Žå‘³'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
      version_name:
        description: 'è¯·è¾“å…¥è¦å‘å¸ƒçš„è½¯ä»¶ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        type: string

jobs:
  # Job 1: å‡†å¤‡å’Œå®¡æ ¸ (ä¸å—çŽ¯å¢ƒé”é™åˆ¶ï¼Œç«‹å³è¿è¡Œå¹¶æ‰§è¡Œé¢„æ£€)
  prepare_review:
    name: å‡†å¤‡ã€é¢„æ£€å¹¶æ˜¾ç¤ºå‘å¸ƒå‚æ•°
    runs-on: ubuntu-latest

    outputs:
      build_run_id_out: ${{ github.event.inputs.build_run_id }}
      build_flavor_out: ${{ github.event.inputs.build_flavor }}
      version_name_out: ${{ github.event.inputs.version_name }}
      # ä¼ é€’æŸ¥æ‰¾åˆ°çš„ Artifact IDï¼Œä¾› Job 2 ç›´æŽ¥ä¸‹è½½
      artifact_id_out: ${{ steps.validate_artifact.outputs.artifact_id_out }}

    steps:
      - name: ðŸ“ å…³é”®å‚æ•°å±•ç¤º (è¯·å®¡æ ¸è€…æ ¸å¯¹)
        run: |
          echo "--- å¾…å®¡æ ¸å‘å¸ƒå‚æ•° ---"
          echo "ç‰ˆæœ¬å· (Version): ${{ github.event.inputs.version_name }}"
          echo "å‘å¸ƒé£Žå‘³ (Flavor): ${{ github.event.inputs.build_flavor }}"
          echo "åŸºäºŽæž„å»º Run ID: ${{ github.event.inputs.build_run_id }}"
          echo "------------------------"

      - name: ðŸ” é¢„æ£€ï¼šéªŒè¯ Artifact å’Œæº Run çŠ¶æ€
        id: validate_artifact
        uses: actions/github-script@v7
        with:
          script: |
            const { build_run_id, build_flavor } = context.payload.inputs;
            const artifactName = `app-${build_flavor}-release-apk`;
            
            core.info(`æ‰§è¡Œé¢„æ£€ï¼šéªŒè¯ Run ID ${build_run_id} æ˜¯å¦æˆåŠŸä¸”åŒ…å« Artifact: ${artifactName}`);
            
            // 1. æ£€æŸ¥æº Run çš„çŠ¶æ€æ˜¯å¦ä¸º 'success'
            const sourceRun = await github.rest.actions.getWorkflowRun({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: build_run_id,
            });
            
            if (sourceRun.data.conclusion !== 'success') {
                core.setFailed(`æºæž„å»º Run ID ${build_run_id} çŠ¶æ€ä¸º ${sourceRun.data.conclusion}ï¼Œå¿…é¡»æ˜¯ 'success' æ‰èƒ½å‘å¸ƒï¼`);
                return;
            }
            core.info(`âœ… æºæž„å»º Run çŠ¶æ€æ£€æŸ¥é€šè¿‡: ${sourceRun.data.conclusion}`);

            // 2. æŸ¥æ‰¾ Artifact æ˜¯å¦å­˜åœ¨
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: build_run_id,
            });
            
            const matchArtifact = artifacts.data.artifacts.filter(artifact => {
              return artifact.name === artifactName
            })[0];
            
            if (!matchArtifact) {
              core.setFailed(`åœ¨ Run ID ${build_run_id} ä¸­æœªæ‰¾åˆ° Artifact: ${artifactName}ï¼è¯·æ£€æŸ¥ Run ID å’Œé£Žå‘³æ˜¯å¦æ­£ç¡®ã€‚`);
              return;
            }
            
            core.info(`âœ… Artifact å­˜åœ¨æ€§æ£€æŸ¥é€šè¿‡ã€‚Artifact ID: ${matchArtifact.id}`);
            core.setOutput('artifact_id_out', matchArtifact.id); # ä¼ é€’ Artifact ID

  # Job 2: å®¡æ ¸å¹¶å‘å¸ƒ (å—çŽ¯å¢ƒé”é™åˆ¶ï¼Œåªæœ‰åœ¨ Job 1 æˆåŠŸé¢„æ£€å¹¶é€šè¿‡å®¡æ ¸åŽæ‰è¿è¡Œ)
  release:
    name: æ‰¹å‡†åŽæ‰§è¡Œå‘å¸ƒåˆ° GitHub Releases
    runs-on: ubuntu-latest

    needs: prepare_review
    environment: Production-Release

    permissions:
      contents: write

    steps:
      # 1. ä¸‹è½½æŒ‡å®šçš„ Artifact ZIP æ–‡ä»¶ (ä¸å†é‡å¤æŸ¥æ‰¾å’Œæ ¡éªŒ)
      - name: ä¸‹è½½æŒ‡å®šçš„ Artifact ZIP æ–‡ä»¶
        uses: actions/github-script@v7
        id: download_artifact
        with:
          script: |
            // ä»Ž Job 1 çš„ outputs ä¸­èŽ·å–æ‰€æœ‰å‚æ•°
            const build_flavor = process.env.BUILD_FLAVOR;
            const version_name = process.env.VERSION_NAME;
            const artifactId = process.env.ARTIFACT_ID; 

            const artifactName = `app-${build_flavor}-release-apk`;
            const zipFileName = `${artifactName}.zip`; 
            
            core.info(`å‡†å¤‡å‘å¸ƒç‰ˆæœ¬ï¼š${version_name}ï¼Œé£Žå‘³ï¼š${build_flavor}ï¼Œå¼€å§‹ä¸‹è½½ Artifact ID: ${artifactId}`);
            
            // ç›´æŽ¥ä¸‹è½½ Artifact çš„äºŒè¿›åˆ¶æ•°æ®
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: artifactId, 
              archive_format: 'zip',
            });
            
            // å°†äºŒè¿›åˆ¶æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿ
            const fs = require('fs');
            fs.writeFileSync(zipFileName, Buffer.from(download.data)); 
            
            // è®¾ç½®è¾“å‡ºå˜é‡ï¼šZIP æ–‡ä»¶åã€é£Žå‘³ å’Œ ç‰ˆæœ¬å·
            core.setOutput('zip_file', zipFileName);
            core.setOutput('flavor', build_flavor);
            core.setOutput('version', version_name);

        env:
          BUILD_FLAVOR: ${{ needs.prepare_review.outputs.build_flavor_out }}
          VERSION_NAME: ${{ needs.prepare_review.outputs.version_name_out }}
          ARTIFACT_ID: ${{ needs.prepare_review.outputs.artifact_id_out }} # ä½¿ç”¨ Job 1 æŸ¥æ‰¾åˆ°çš„ ID

      # 2. è§£åŽ‹ Artifact
      - name: è§£åŽ‹ Artifact å¹¶è®¾ç½®æ‰€æœ‰ APK è·¯å¾„
        id: unzip_and_set_path
        run: |
          ARTIFACT_ZIP_FILE=${{ steps.download_artifact.outputs.zip_file }}          
          
          echo "å¼€å§‹è§£åŽ‹æ–‡ä»¶ï¼š$ARTIFACT_ZIP_FILE"
          mkdir -p artifacts/
          unzip -o $ARTIFACT_ZIP_FILE -d ./artifacts/
          
          ALL_APKS_PATH='./artifacts/*.apk'
          
          echo "è®¾ç½®æ–‡ä»¶ä¸Šä¼ è·¯å¾„ï¼ˆé€šé…ç¬¦ï¼‰ï¼š$ALL_APKS_PATH"
          echo "artifact_path=$ALL_APKS_PATH" >> $GITHUB_OUTPUT

      # 3. åˆ›å»º GitHub Release
      - name: åˆ›å»º/æ›´æ–° GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.download_artifact.outputs.version }}-${{ steps.download_artifact.outputs.flavor }}
          name: Android Release v${{ steps.download_artifact.outputs.version }} (${{ steps.download_artifact.outputs.flavor }})
          draft: ${{ steps.download_artifact.outputs.flavor != 'prod' }}
          prerelease: ${{ steps.download_artifact.outputs.flavor == 'dev' }}
          files: ${{ steps.unzip_and_set_path.outputs.artifact_path }}