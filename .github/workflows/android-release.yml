name: éœ€è¦å®¡æ ¸çš„å‘å¸ƒæ“ä½œ

on:
  workflow_dispatch:
    inputs:
      build_run_id:
        description: 'è¯·å¡«å†™ Build CI æˆåŠŸçš„ Run ID (ä¾‹å¦‚ï¼š123456789)'
        required: true
        type: string
      build_flavor:
        description: 'è¯·é€‰æ‹©è¦å‘å¸ƒçš„ç‰ˆæœ¬é£å‘³'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
      version_name:
        description: 'è¯·è¾“å…¥è¦å‘å¸ƒçš„è½¯ä»¶ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        type: string

jobs:
  # Job 1: å‡†å¤‡å’Œå®¡æ ¸
  prepare_review:
    name: å‡†å¤‡ã€é¢„æ£€å¹¶æ˜¾ç¤ºå‘å¸ƒå‚æ•°
    runs-on: ubuntu-latest

    permissions:
      contents: read

    outputs:
      build_run_id_out: ${{ github.event.inputs.build_run_id }}
      build_flavor_out: ${{ github.event.inputs.build_flavor }}
      version_name_out: ${{ github.event.inputs.version_name }}
      artifact_id_out: ${{ steps.validate_artifact.outputs.artifact_id_out }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å…³é”®å‚æ•°å±•ç¤º (è¯·å®¡æ ¸è€…æ ¸å¯¹)
        run: |
          echo "--- å¾…å®¡æ ¸å‘å¸ƒå‚æ•° ---"
          echo "ç‰ˆæœ¬å· (Version): ${{ github.event.inputs.version_name }}"
          echo "å‘å¸ƒé£å‘³ (Flavor): ${{ github.event.inputs.build_flavor }}"
          echo "åŸºäºæ„å»º Run ID: ${{ github.event.inputs.build_run_id }}"
          echo "------------------------"

      - name: ğŸ” é¢„æ£€ï¼šæ£€æŸ¥ç›®æ ‡æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        run: |
          BUILD_FLAVOR=${{ github.event.inputs.build_flavor }}
          VERSION_NAME=${{ github.event.inputs.version_name }}
          
          # è®¡ç®—ç›®æ ‡æ ‡ç­¾åï¼ˆä¿æŒä¸ Job 2 çš„æ ‡ç­¾å‘½åè§„åˆ™ä¸€è‡´ï¼‰
          if [ "$BUILD_FLAVOR" == "prod" ]; then
            RELEASE_TAG="v${VERSION_NAME}"
          else
            RELEASE_TAG="v${VERSION_NAME}-${BUILD_FLAVOR}" 
          fi

          echo "ç›®æ ‡ Release æ ‡ç­¾å: $RELEASE_TAG"
          
          # ä½¿ç”¨ git rev-parse æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
          if git rev-parse --verify "refs/tags/$RELEASE_TAG" >/dev/null 2>&1; then
             echo "ğŸš¨ ä¸¥é‡é”™è¯¯ï¼šç›®æ ‡ Release æ ‡ç­¾ [$RELEASE_TAG] å·²å­˜åœ¨äº Git ä»“åº“ä¸­ã€‚"
             echo "è¯·ä¿®æ”¹ç‰ˆæœ¬å·æˆ–æ‰‹åŠ¨åˆ é™¤æ—§æ ‡ç­¾åé‡è¯•ã€‚"
             exit 1 # å¼ºåˆ¶å·¥ä½œæµå¤±è´¥
          fi
          echo "âœ… ç›®æ ‡æ ‡ç­¾ [$RELEASE_TAG] æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥åˆ›å»ºã€‚"

      - name: é¢„æ£€ï¼šéªŒè¯ Artifact å’Œæº Run çŠ¶æ€
        id: validate_artifact
        uses: actions/github-script@v7
        with:
          script: |
            const { build_run_id, build_flavor } = context.payload.inputs;
            const artifactName = `app-${build_flavor}-release-apk`;

            core.info(`æ‰§è¡Œé¢„æ£€ï¼šéªŒè¯ Run ID ${build_run_id} æ˜¯å¦æˆåŠŸä¸”åŒ…å« Artifact: ${artifactName}`);

            // 1. æ£€æŸ¥æº Run çš„çŠ¶æ€æ˜¯å¦ä¸º 'success'
            const sourceRun = await github.rest.actions.getWorkflowRun({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: build_run_id,
            });

            if (sourceRun.data.conclusion !== 'success') {
                core.setFailed(`æºæ„å»º Run ID ${build_run_id} çŠ¶æ€ä¸º ${sourceRun.data.conclusion}ï¼Œå¿…é¡»æ˜¯ 'success' æ‰èƒ½å‘å¸ƒï¼`);
                return;
            }
            core.info(`âœ… æºæ„å»º Run çŠ¶æ€æ£€æŸ¥é€šè¿‡: ${sourceRun.data.conclusion}`);

            // 2. æŸ¥æ‰¾ Artifact æ˜¯å¦å­˜åœ¨
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: build_run_id,
            });

            const matchArtifact = artifacts.data.artifacts.filter(artifact => {
              return artifact.name === artifactName
            })[0];

            if (!matchArtifact) {
              core.setFailed(`åœ¨ Run ID ${build_run_id} ä¸­æœªæ‰¾åˆ° Artifact: ${artifactName}ï¼è¯·æ£€æŸ¥ Run ID å’Œé£å‘³æ˜¯å¦æ­£ç¡®ã€‚`);
              return;
            }

            core.info(`âœ… Artifact å­˜åœ¨æ€§æ£€æŸ¥é€šè¿‡ã€‚Artifact ID: ${matchArtifact.id}`);
            core.setOutput('artifact_id_out', matchArtifact.id);


  # Job 2: å®¡æ ¸å¹¶å‘å¸ƒ (å—ç¯å¢ƒé”é™åˆ¶ï¼Œåªæœ‰åœ¨ Job 1 æˆåŠŸé¢„æ£€å¹¶é€šè¿‡å®¡æ ¸åæ‰è¿è¡Œ)
  release:
    name: æ‰¹å‡†åæ‰§è¡Œå‘å¸ƒåˆ° GitHub Releases
    runs-on: ubuntu-latest

    needs: prepare_review
    environment: Production-Release

    permissions:
      contents: write

    steps:
      # 0. æ£€å‡ºä»£ç  (Action å¿…å¤‡ï¼Œç”¨äºè®¿é—® changelog-generator å’Œ git å†å²)
      - name: â¬‡ï¸ æ£€å‡ºä»“åº“ä»£ç  (è·å–å®Œæ•´å†å²)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å¿…é¡»è·å–å…¨éƒ¨å†å²ï¼Œä»¥ä¾¿ git log/tag

      # 1. è®¡ç®— Release åç§°å’Œ Changelog æ ‡é¢˜/æ ‡ç­¾
      - name: âš™ï¸ è®¡ç®—æœ€ç»ˆæ ‡ç­¾åå’Œ Changelog æ ‡é¢˜
        id: compute_names
        run: |
          BUILD_FLAVOR=${{ needs.prepare_review.outputs.build_flavor_out }}
          VERSION_NAME=${{ needs.prepare_review.outputs.version_name_out }}
          
          # æ„é€ æ ‡ç­¾åã€Release æ˜¾ç¤ºåå’Œ Changelog æ ‡é¢˜ (ä¸ Job 1 çš„é¢„æ£€é€»è¾‘ä¸€è‡´)
          if [ "$BUILD_FLAVOR" == "prod" ]; then
            # Prod ç‰ˆæœ¬ï¼šæ ‡ç­¾åä¸å¸¦åç¼€ (e.g., v1.0.0)
            RELEASE_TAG="v${VERSION_NAME}"
            RELEASE_NAME="v${VERSION_NAME} (Production)"
            CHANGELOG_TITLE="v${VERSION_NAME}"
          else
            # Dev ç‰ˆæœ¬ï¼šæ ‡ç­¾åå¸¦åç¼€ (e.g., v1.0.0-dev)
            RELEASE_TAG="v${VERSION_NAME}-${BUILD_FLAVOR}"
            RELEASE_NAME="v${VERSION_NAME} (${BUILD_FLAVOR})"
            CHANGELOG_TITLE="v${VERSION_NAME}-${BUILD_FLAVOR}"
          fi

          echo "Release Tag: $RELEASE_TAG"
          
          # è®¾ç½®è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "changelog_title=$CHANGELOG_TITLE" >> $GITHUB_OUTPUT
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT

      # 2. è°ƒç”¨ Changelog Generator å¹¶è·å–å†…å®¹
      - name: ğŸ“„ ç”Ÿæˆå¹¶è·å–æ›´æ–°æ—¥å¿—å†…å®¹
        id: generate_changelog
        # å‡è®¾æ‚¨çš„ Action è·¯å¾„ä¸º ./.github/actions/changelog-generator/
        uses: ./.github/actions/changelog-generator/@main
        with:
          version_title: ${{ steps.compute_names.outputs.changelog_title }}
          # previous_tag ç•™ç©ºï¼Œè®© Action å†…éƒ¨çš„é€»è¾‘è‡ªåŠ¨æ¨å¯¼å‡ºä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾

      # 3. ä¸‹è½½æŒ‡å®šçš„ Artifact ZIP æ–‡ä»¶
      - name: ä¸‹è½½æŒ‡å®šçš„ Artifact ZIP æ–‡ä»¶
        uses: actions/github-script@v7
        id: download_artifact
        with:
          script: |
            // ä»ç¯å¢ƒå˜é‡ä¸­è·å–å‚æ•°
            const build_flavor = process.env.BUILD_FLAVOR;
            const version_name = process.env.VERSION_NAME;
            const artifactId = process.env.ARTIFACT_ID; 

            const artifactName = `app-${build_flavor}-release-apk`;
            const zipFileName = `${artifactName}.zip`; 
            
            core.info(`å‡†å¤‡å‘å¸ƒç‰ˆæœ¬ï¼š${version_name}ï¼Œé£å‘³ï¼š${build_flavor}ï¼Œå¼€å§‹ä¸‹è½½ Artifact ID: ${artifactId}`);
            
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: artifactId, 
              archive_format: 'zip',
            });
            
            const fs = require('fs');
            fs.writeFileSync(zipFileName, Buffer.from(download.data)); 
            
            core.setOutput('zip_file', zipFileName);

        env:
          BUILD_FLAVOR: ${{ needs.prepare_review.outputs.build_flavor_out }}
          VERSION_NAME: ${{ needs.prepare_review.outputs.version_name_out }}
          ARTIFACT_ID: ${{ needs.prepare_review.outputs.artifact_id_out }}

      # 4. è§£å‹ Artifact
      - name: è§£å‹ Artifact å¹¶è®¾ç½®æ‰€æœ‰ APK è·¯å¾„
        id: unzip_and_set_path
        run: |
          ARTIFACT_ZIP_FILE=${{ steps.download_artifact.outputs.zip_file }}          
          
          echo "å¼€å§‹è§£å‹æ–‡ä»¶ï¼š$ARTIFACT_ZIP_FILE"
          mkdir -p artifacts/
          unzip -o $ARTIFACT_ZIP_FILE -d ./artifacts/
          
          ALL_APKS_PATH='./artifacts/*.apk'
          
          echo "è®¾ç½®æ–‡ä»¶ä¸Šä¼ è·¯å¾„ï¼ˆé€šé…ç¬¦ï¼‰ï¼š$ALL_APKS_PATH"
          echo "artifact_path=$ALL_APKS_PATH" >> $GITHUB_OUTPUT

      # 5. åˆ›å»º GitHub Release
      - name: åˆ›å»º/æ›´æ–° GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # ä½¿ç”¨è®¡ç®—å‡ºçš„æœ€ç»ˆæ ‡ç­¾å
          tag_name: ${{ steps.compute_names.outputs.release_tag }}
          # ä½¿ç”¨è®¡ç®—å‡ºçš„ Release æ˜¾ç¤ºåç§°
          name: ${{ steps.compute_names.outputs.release_name }}
          # ä½¿ç”¨ Changelog Generator çš„è¾“å‡ºä½œä¸º Release æ­£æ–‡
          body: ${{ steps.generate_changelog.outputs.changelog_content }}
          # åªæœ‰é Prod ç‰ˆæœ¬æ‰è®¾ç½®ä¸º Draft
          draft: ${{ needs.prepare_review.outputs.build_flavor_out != 'prod' }}
          # åªæœ‰ Dev ç‰ˆæœ¬æ‰è®¾ç½®ä¸º Prerelease
          prerelease: ${{ needs.prepare_review.outputs.build_flavor_out == 'dev' }}
          files: ${{ steps.unzip_and_set_path.outputs.artifact_path }}