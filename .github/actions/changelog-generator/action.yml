name: 'ç”Ÿæˆå¹¶è¾“å‡ºæ›´æ–°æ—¥å¿—'
description: 'è¿è¡Œ generate_changelog.py è„šæœ¬ï¼Œè‡ªåŠ¨æ¨å¯¼ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾ï¼Œå¹¶å°†ç”Ÿæˆçš„æ›´æ–°æ—¥å¿—å†…å®¹ä½œä¸ºå­—ç¬¦ä¸²å˜é‡è¾“å‡ºã€‚'

# --- è¾“å…¥å®šä¹‰ ---
inputs:
  version_title:
    description: 'æœ¬æ¬¡æ›´æ–°æ—¥å¿—çš„ç‰ˆæœ¬å· (e.g., v1.0.0)'
    required: true
  previous_tag:
    description: 'ç”¨äº Git log æ¯”è¾ƒçš„èµ·å§‹æ ‡ç­¾æˆ–Commitå“ˆå¸Œ (å¯é€‰ï¼Œå¦‚æœæä¾›åˆ™è¦†ç›–è‡ªåŠ¨æ¨å¯¼)'
    required: false
    default: ''

# --- è¾“å‡ºå®šä¹‰ ---
outputs:
  changelog_content:
    description: 'ç”Ÿæˆçš„ CHANGELOG.md æ–‡ä»¶çš„å…¨éƒ¨ Markdown å†…å®¹ (å­—ç¬¦ä¸²)'
    value: ${{ steps.generate.outputs.changelog_content }}

# --- å®é™…æ‰§è¡Œçš„æ­¥éª¤ ---
runs:
  using: "composite"
  steps:
    - name: ğŸ è®¾ç½® Python ç¯å¢ƒ (Action å†…éƒ¨)
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: âš™ï¸ æ‰§è¡Œè„šæœ¬å¹¶æ•è·è¾“å‡º
      id: generate
      shell: bash
      run: |
        VERSION_TITLE="${{ inputs.version_title }}"
        PREVIOUS_TAG="${{ inputs.previous_tag }}"
        
        # --- è‡ªåŠ¨æ¨å¯¼æ¯”è¾ƒæ ‡ç­¾é€»è¾‘ (åŸºäºæ—¶é—´æ’åº) ---
        if [[ -z "$PREVIOUS_TAG" ]]; then
            echo "æœªæä¾›å¯¹æ¯”æ ‡ç­¾ï¼Œå¼€å§‹è‡ªåŠ¨æ¨å¯¼ï¼ˆåŸºäºæ—¶é—´æ’åºï¼‰..."
        
            # ä½¿ç”¨ --sort=-committerdate (æ—¶é—´é™åº) è¿›è¡Œæ’åº
        
            if [[ "$VERSION_TITLE" == *"-dev"* ]]; then
                # æƒ…å†µä¸€ï¼šå½“å‰æ˜¯å¼€å‘ç‰ˆæœ¬ (vX.Y.Z-dev...)
                PREVIOUS_TAG=$(git tag --list "*-dev*" --sort=-committerdate | grep -v --fixed-strings "$VERSION_TITLE" | head -n 1)
            else
                # æƒ…å†µäºŒï¼šå½“å‰æ˜¯ç¨³å®šç‰ˆæœ¬ (vX.Y.Z)
                PREVIOUS_TAG=$(git tag --list --sort=-committerdate --exclude="*-dev*" | grep -v --fixed-strings "$VERSION_TITLE" | head -n 1)
            fi
        
            if [[ -n "$PREVIOUS_TAG" ]]; then
                echo "è‡ªåŠ¨æ¨å¯¼çš„ä¸Šä¸€ä¸ªæ ‡ç­¾ä¸º: $PREVIOUS_TAG"
            else
                echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°åˆé€‚çš„ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œå°†ä¾èµ–Pythonè„šæœ¬å›é€€åˆ°ä»“åº“åˆå§‹æäº¤ã€‚"
            fi
        fi
        # --- è‡ªåŠ¨æ¨å¯¼é€»è¾‘ç»“æŸ ---
        
        # æ‰§è¡Œ Python è„šæœ¬
        python ${{ github.action_path }}/generate_changelog.py "$VERSION_TITLE" "$PREVIOUS_TAG"

        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
        if [ ! -f CHANGELOG.md ]; then
          echo "è­¦å‘Šï¼šCHANGELOG.md æ–‡ä»¶æœªç”Ÿæˆï¼Œå¯èƒ½èŒƒå›´å†…æ²¡æœ‰æœ‰æ•ˆæäº¤ã€‚"
          CHANGELOG_CONTENT=""
        else
          # è¯»å– CHANGELOG.md æ–‡ä»¶å†…å®¹
          CHANGELOG_CONTENT=$(cat CHANGELOG.md)
        fi
        
        # ã€å…³é”®ã€‘å°†å¤šè¡Œå†…å®¹è®¾ç½®ä¸º Action çš„è¾“å‡ºå˜é‡ï¼Œä½¿ç”¨ EOF æ–¹å¼
        echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT