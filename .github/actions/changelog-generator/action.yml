name: 'Changelog Generator'
description: 'Generates a formatted changelog from Git history.'

inputs:
  version_title:
    required: true
  previous_tag:
    required: false
    default: ''

outputs:
  changelog_content:
    description: "The generated Markdown content for the Release body."
    value: ${{ steps.generate_content.outputs.changelog_content }}

runs:
  using: "composite"
  steps:
    - name: å¼ºåˆ¶è·å–å®Œæ•´æ ‡ç­¾å†å²
      shell: bash
      run: git fetch --tags

    - name: ğŸ“„ ç”Ÿæˆæ›´æ–°æ—¥å¿—å¹¶è®¾ç½®è¾“å‡º
      id: generate_content # <--- å…³é”®ä¿®æ­£ï¼šä¸º run æ­¥éª¤æ·»åŠ  ID
      shell: bash
      run: |
        VERSION_TITLE="${{ inputs.version_title }}"
        PREVIOUS_TAG="${{ inputs.previous_tag }}"
        
        # --- è‡ªåŠ¨æ¨å¯¼æ¯”è¾ƒæ ‡ç­¾é€»è¾‘ (åŸºäºæ—¶é—´æ’åº) ---
        if [[ -z "$PREVIOUS_TAG" ]]; then
            echo "æœªæä¾›å¯¹æ¯”æ ‡ç­¾ï¼Œå¼€å§‹è‡ªåŠ¨æ¨å¯¼ï¼ˆåŸºäºæ—¶é—´æ’åºï¼‰..."
        
            # ä½¿ç”¨ --sort=-committerdate (æ—¶é—´é™åº) è¿›è¡Œæ’åº
        
            if [[ "$VERSION_TITLE" == *"-dev"* ]]; then
                # ã€å…³é”®ä¿®æ­£ã€‘ï¼šä½¿ç”¨ || true ç¡®ä¿å³ä½¿æ²¡æœ‰æ ‡ç­¾æ‰¾åˆ°ï¼Œç®¡é“å‘½ä»¤ä¹Ÿä¸ä¼šä½¿è„šæœ¬é€€å‡º
                PREVIOUS_TAG=$(git tag --list "*-dev*" --sort=-committerdate | grep -v --fixed-strings "$VERSION_TITLE" | head -n 1) || true
            else
                # ã€å…³é”®ä¿®æ­£ã€‘ï¼šä½¿ç”¨ || true ç¡®ä¿å³ä½¿æ²¡æœ‰æ ‡ç­¾æ‰¾åˆ°ï¼Œç®¡é“å‘½ä»¤ä¹Ÿä¸ä¼šä½¿è„šæœ¬é€€å‡º
                PREVIOUS_TAG=$(git tag --list --sort=-committerdate --exclude="*-dev*" | grep -v --fixed-strings "$VERSION_TITLE" | head -n 1) || true
            fi
        
            if [[ -n "$PREVIOUS_TAG" ]]; then
                echo "è‡ªåŠ¨æ¨å¯¼çš„ä¸Šä¸€ä¸ªæ ‡ç­¾ä¸º: $PREVIOUS_TAG"
            else
                # å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼ŒPREVIOUS_TAG ä»ç„¶æ˜¯ç©ºï¼ŒPython è„šæœ¬ä¼šå®‰å…¨åœ°å›é€€åˆ°åˆå§‹ Commit
                echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°åˆé€‚çš„ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œå°†ä¾èµ–Pythonè„šæœ¬å›é€€åˆ°ä»“åº“åˆå§‹æäº¤ã€‚"
            fi
        fi
        # --- è‡ªåŠ¨æ¨å¯¼é€»è¾‘ç»“æŸ ---
        
        # ã€æ–°å¢è°ƒè¯•ä»£ç ã€‘æ‰“å° Python è„šæœ¬çš„è·¯å¾„ï¼Œç”¨äºæ’æŸ¥é—®é¢˜
        echo "DEBUG: GITHUB_ACTION_PATH is $GITHUB_ACTION_PATH"
        
        # æ‰§è¡Œ Python è„šæœ¬
        python $GITHUB_ACTION_PATH/generate_changelog.py "$VERSION_TITLE" "$PREVIOUS_TAG" 2>&1
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
        if [ ! -f CHANGELOG.md ]; then
          echo "è­¦å‘Šï¼šCHANGELOG.md æ–‡ä»¶æœªç”Ÿæˆï¼Œå¯èƒ½èŒƒå›´å†…æ²¡æœ‰æœ‰æ•ˆæäº¤ã€‚"
          CHANGELOG_CONTENT=""
        else
          # è¯»å– CHANGELOG.md æ–‡ä»¶å†…å®¹
          CHANGELOG_CONTENT=$(cat CHANGELOG.md)
        fi
        
        # ã€å…³é”®ã€‘å°†å¤šè¡Œå†…å®¹è®¾ç½®ä¸º Action çš„è¾“å‡ºå˜é‡ï¼Œä½¿ç”¨ EOF æ–¹å¼
        # è®¾ç½®å†…éƒ¨æ­¥éª¤çš„è¾“å‡º (steps.<step_id>.outputs.<output_name>)
        echo "changelog_content<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
